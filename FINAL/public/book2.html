<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BOOK A CLASS</title>
  <link rel="stylesheet" href="css/book2.css" />
  <style>
    /* Modal styles (paste into book2.css if you prefer) */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal-box {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      width: 420px;
      max-width: 92%;
      box-shadow: 0 8px 30px rgba(0,0,0,0.4);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    .modal-box h3 { margin-top: 0; margin-bottom: 12px; text-align: center; }
    .modal-box p { margin: 6px 0; color: #333; }
    .confirm-actions { display:flex; gap:10px; margin-top:16px; }
    .confirm-actions button {
      flex:1; padding:10px 12px; border-radius:8px; border:none; font-weight:700; cursor:pointer;
    }
    .confirm-actions button[data-action="confirm"],
    .confirm-actions button[data-action="yes"] { background:#28a745; color:#fff; }
    .confirm-actions button[data-action="cancel"],
    .confirm-actions button[data-action="no"] { background:#dc3545; color:#fff; }
  </style>
</head>
<body>

<header>
  <div class="logo">ADDLIB DANCE STUDIO TADS</div>
  <nav>
    <a href="home.html">HOME</a>
    <a href="about.html">ABOUT</a>
    <a href="book.html" class="active">BOOK A CLASS</a>
    <a href="rent.html">RENT</a>
    <a href="contact.html">CONTACT US</a>
    <div class="hamburger" id="hamburger">&#9776;</div>
  </nav>
</header>

<div class="side-menu" id="sideMenu">
  <div class="close-btn" id="closeBtn">&times;</div>
  <hr>
  <button id="toggleDarkMode" class="toggle-btn">üåô Dark Mode</button>
  <a href="admin-login.html">ADMIN LOGIN</a>
</div>

<div class="menu-overlay" id="menuOverlay"></div>

<section class="schedule-container">
  <h2>SCHEDULE YOUR SERVICE</h2>
</section>

<section class="booking">
  <h2>Booking Form</h2>
  <div class="form-container">
    <form class="client-details" onsubmit="return false;">
      <h3>Client Details</h3>

      <label>Full Name</label>
      <input type="text" id="fullname" required>

      <label>Email</label>
      <input type="email" id="email" placeholder="example@email.com" required>

      <label>Phone Number</label>
      <input type="tel" id="phone" placeholder="09XXXXXXXXX" maxlength="11" required>

      <label for="participants">Number of Participants</label>
      <select id="participants">
        <!-- static options (no template code) -->
        <option value="1">1</option><option value="2">2</option><option value="3">3</option>
        <option value="4">4</option><option value="5">5</option><option value="6">6</option>
        <option value="7">7</option><option value="8">8</option><option value="9">9</option>
        <option value="10">10</option><option value="11">11</option><option value="12">12</option>
        <option value="13">13</option><option value="14">14</option><option value="15">15</option>
        <option value="16">16</option><option value="17">17</option><option value="18">18</option>
        <option value="19">19</option><option value="20">20</option>
      </select>

      <h3>Selected Class</h3>
      <div id="selectedClassBox" class="selected-class-box">
        <p><strong>Style:</strong> <span id="classStyle">-</span></p>
        <p><strong>Level:</strong> <span id="classLevel">-</span></p>
        <p><strong>Duration:</strong> <span id="classDuration">-</span></p>
        <p><strong>Price:</strong> <span id="classPrice">-</span></p>
        <p><strong>Date:</strong> <span id="classDate">-</span></p>
        <p><strong>Class Type:</strong> <span id="classTypeDisplay">-</span></p>
      </div>
    </form>
  </div>

  <div class="action-buttons">
    <button type="button" class="paynow">CONFIRM</button>
    <button type="button" class="cancel-btn">CANCEL</button>
  </div>
</section>

<footer>
  <p>The Addlib Dance Studio</p>
  <p>2F New Frontier Theater Arcade, 7 Gen. Malvar Ave. Araneta City, Quezon City, Philippines</p>
  <p>Email: letsdance@tadsph.com</p>
</footer>

<!-- script (module) -->
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabaseUrl = "https://rxyhvltcvporwvkysstc.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4eWh2bHRjdnBvcnd2a3lzc3RjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NzU2NjksImV4cCI6MjA3MzM1MTY2OX0.we1I_TA421YdD6wJwxvcucqSEnToSD0i9MQ3JNoAexU";
const supabase = createClient(supabaseUrl, supabaseKey);

document.addEventListener("DOMContentLoaded", () => {
  // elements
  const classStyleEl = document.getElementById("classStyle");
  const classLevelEl = document.getElementById("classLevel");
  const classDurationEl = document.getElementById("classDuration");
  const classPriceEl = document.getElementById("classPrice");
  const classDateEl = document.getElementById("classDate");
  const classTypeDisplayEl = document.getElementById("classTypeDisplay");

  const fullnameEl = document.getElementById("fullname");
  const emailEl = document.getElementById("email");
  const phoneEl = document.getElementById("phone");
  const participantsEl = document.getElementById("participants");
  const confirmBtn = document.querySelector(".paynow");
  const cancelBtn = document.querySelector(".cancel-btn");

  const params = new URLSearchParams(window.location.search);
  const classId = params.get("id");
  const classTypeFromURL = params.get("type");
  const classDateFromURL = params.get("class_date"); // NEW


  // load class details
  async function loadSelectedClass() {
    if (!classId || !classTypeFromURL) return;
    const tableName = classTypeFromURL === "Dance Class" ? "dance_classes" : "private_classes";
    try {
      const { data, error } = await supabase.from(tableName).select("*").eq("id", classId).single();
      if (error) throw error;
      classStyleEl.textContent = data.style ?? "-";
      classLevelEl.textContent = data.level ?? "-";
      classDurationEl.textContent = data.duration ?? "-";
      classPriceEl.textContent = data.price ? `‚Ç±${data.price}` : "-";
      classDateEl.textContent = classDateFromURL ?? data.date ?? "-";
      classTypeDisplayEl.textContent = classTypeFromURL ?? "-";
    } catch (err) {
      console.error("Error loading class:", err);
    }
  }

  // phone input sanitize
  phoneEl.addEventListener("input", () => {
    phoneEl.value = phoneEl.value.replace(/[^0-9]/g, "").slice(0, 11);
  });

  // helper to create modal overlay
  function createOverlay(innerHtml) {
    const old = document.querySelector(".modal-overlay");
    if (old) old.remove();
    const overlay = document.createElement("div");
    overlay.className = "modal-overlay";
    overlay.innerHTML = `<div class="modal-box">${innerHtml}</div>`;
    document.body.appendChild(overlay);
    return overlay;
  }

  // confirm button opens modal
  confirmBtn.addEventListener("click", () => {
    const fullname = fullnameEl.value.trim();
    const email = emailEl.value.trim();
    const phone = phoneEl.value.trim();
    const participants = participantsEl.value;

    if (!fullname || !email || !phone) {
      alert("‚ö†Ô∏è Please fill all fields (name, email, phone).");
      return;
    }

    const content = `
      <h3>Confirm Booking</h3>
      <p><strong>Name:</strong> ${escapeHtml(fullname)}</p>
      <p><strong>Email:</strong> ${escapeHtml(email)}</p>
      <p><strong>Phone:</strong> ${escapeHtml(phone)}</p>
      <p><strong>Participants:</strong> ${escapeHtml(participants)}</p>
      <p><strong>Class:</strong> ${escapeHtml(classTypeFromURL || "-")}</p>
      <p><strong>Style:</strong> ${escapeHtml(classStyleEl.textContent)}</p>
      <p><strong>Level:</strong> ${escapeHtml(classLevelEl.textContent)}</p>
      <p><strong>Duration:</strong> ${escapeHtml(classDurationEl.textContent)}</p>
      <p><strong>Price:</strong> ${escapeHtml(classPriceEl.textContent)}</p>
      <p><strong>Date:</strong> ${escapeHtml(classDateEl.textContent)}</p>
      <div class="confirm-actions">
        <button data-action="confirm">Confirm</button>
        <button data-action="cancel">Cancel</button>
      </div>
    `;
    const overlay = createOverlay(content);

    overlay.addEventListener("click", async (ev) => {
      const btn = ev.target.closest("button[data-action]");
      if (!btn) return;
      const action = btn.getAttribute("data-action");
      if (action === "cancel") { overlay.remove(); return; }

      if (action === "confirm") {
        btn.disabled = true
        btn.textContent = "Confirming..."

        try {
          // Build booking data
          const payload = {
            name: fullname,
            email,
            phone,
            participants: parseInt(participants, 10), // store as integer
            style: classStyleEl.textContent,
            level: classLevelEl.textContent,
            duration: classDurationEl.textContent,
            price: classPriceEl.textContent.replace("‚Ç±",""), // clean ‚Ç± sign
            class_date: classDateEl.textContent, 
            class_type: classTypeFromURL ?? null,
            status: "Pending",
            payment: "Unpaid" // ‚úÖ add this so insert succeeds
          };


          // Insert booking
          const { error } = await supabase.from("bookings").insert([payload]);
          if (error) {
            console.error("Insert error:", error); // see exact issue in console
            throw error;
          }


          // Update booked status
          const tableName = classTypeFromURL === "Dance Class" ? "dance_classes" : "private_classes"
          const { error: updateError } = await supabase
            .from(tableName)
            .update({ booked: true })
            .eq("id", classId)

          if (updateError) throw updateError

          // Success feedback
          const box = overlay.querySelector(".modal-box")
          box.innerHTML = `<h3 style="text-align:center;color:#28a745;">‚úÖ Booking Confirmed!</h3>`
          setTimeout(() => {
            overlay.remove()
            window.location.href = "book.html" // go back to refresh available classes
          }, 1500)

        } catch (err) {
          console.error("Booking failed:", err)
          alert("‚ùå Booking failed.")
          btn.disabled = false
          btn.textContent = "Confirm"
        }
      }

    });
  });

  // cancel button
  cancelBtn.addEventListener("click", () => {
    const content = `
      <h3>Cancel Booking?</h3>
      <p>Are you sure you want to cancel? Your form data will be lost.</p>
      <div class="confirm-actions">
        <button data-action="yes">Yes, cancel</button>
        <button data-action="no">No</button>
      </div>
    `;
    const overlay = createOverlay(content);
    overlay.addEventListener("click", (ev) => {
      const btn = ev.target.closest("button[data-action]");
      if (!btn) return;
      const action = btn.getAttribute("data-action");
      if (action === "yes") { overlay.remove(); window.location.href = "home.html"; }
      else overlay.remove();
    });
  });

  function escapeHtml(str) {
    if (str == null) return "";
    return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }

  // side menu, dark mode
  const hamburger = document.getElementById("hamburger");
  const sideMenu = document.getElementById("sideMenu");
  const closeBtn = document.getElementById("closeBtn");
  const toggleDarkMode = document.getElementById("toggleDarkMode");
  hamburger?.addEventListener("click", () => sideMenu?.classList.toggle("open"));
  closeBtn?.addEventListener("click", () => sideMenu?.classList.remove("open"));

  if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("dark-mode");
    if (toggleDarkMode) toggleDarkMode.textContent = "‚òÄÔ∏è Light Mode";
  }
  toggleDarkMode?.addEventListener("click", () => {
    document.body.classList.toggle("dark-mode");
    const isDark = document.body.classList.contains("dark-mode");
    localStorage.setItem("theme", isDark ? "dark" : "light");
    if (toggleDarkMode) toggleDarkMode.textContent = isDark ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
  });

  // initial load
  loadSelectedClass();
});
</script>

</body>
</html>